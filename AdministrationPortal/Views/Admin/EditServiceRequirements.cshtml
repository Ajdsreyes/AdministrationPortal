@model List<AdministrationPortal.Models.ViewModels.ServiceRequirementVM>

@{
    ViewData["Title"] = "Edit Service Requirements";
}

<div class="profile-container">
    <div class="profile-card highlight">

        <div class="page-header">
            <div>
                <h3>Edit Service Requirements</h3>
                <p class="text-muted">
                    Define what information residents must provide for this service
                </p>
            </div>
        </div>

        <form asp-action="SaveServiceRequirements" method="post">
            @* serviceId must match the parameter name in your AdminController *@
            <input type="hidden" name="serviceId" value="@ViewBag.ServiceId" />

            <table class="user-table">
                <thead>
                    <tr>
                        <th>Field Label</th>
                        <th style="width:140px;">Type</th>
                        <th style="width:90px;">Required</th>
                        <th>Options</th>
                        <th style="width:70px;"></th>
                    </tr>
                </thead>

                <tbody id="requirementsBody">
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        <tr>
                            <td>
                                <input type="hidden" name="serviceId" value="@ViewBag.ServiceId" />

                                <button type="button" class="btn btn-iassist" onclick="addNewField()">
                                    <i class="bi bi-plus"></i> Add New Requirement Field
                                </button>

                                <input class="form-input"
                                       name="requirements[@i].Label"
                                       value="@Model[i].PurposeName"
                                       placeholder="e.g. Date of Birth"
                                       required />
                            </td>

                            <td>
                                <select name="requirements[@i].FieldType" class="form-select">
                                    <option value="text" selected="@(Model[i].FieldType == "text")">text</option>
                                    <option value="textarea" selected="@(Model[i].FieldType == "textarea")">textarea</option>
                                    <option value="date" selected="@(Model[i].FieldType == "date")">date</option>
                                    <option value="number" selected="@(Model[i].FieldType == "number")">number</option>
                                    <option value="email" selected="@(Model[i].FieldType == "email")">email</option>
                                    <option value="select" selected="@(Model[i].FieldType == "select")">select</option>
                                </select>
                            </td>

                            <td class="text-center">
                                @* Checkboxes need a value="true" to bind correctly to a boolean *@
                                <input type="checkbox"
                                       name="requirements[@i].IsRequired"
                                       value="true"
                                       @(Model[i].IsRequired ? "checked" : "") />
                                <input type="hidden" name="requirements[@i].IsRequired" value="false" />
                            </td>

                            <td>
                                @* We bind this as a string; the Controller will split it into a List *@
                                <input class="form-input"
                                       name="requirements[@i].Options"
                                       value="@(Model[i].Options != null ? string.Join(",", Model[i].Options) : "")"
                                       placeholder="Only for select fields" />
                            </td>

                            <td class="text-center">
                                <button type="button"
                                        class="btn-icon-danger"
                                        title="Delete field"
                                        onclick="deleteRow(this)">
                                    🗑
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="center-actions">
                <button type="button"
                        class="btn-secondary btn-add"
                        onclick="addRequirement()">
                    ➕ Add Requirement
                </button>
            </div>

            <div class="profile-actions">
                <button type="submit" class="btn-primary">
                    Save Requirements
                </button>

                <a asp-action="BarangayServices" class="btn-secondary">
                    Cancel
                </a>
            </div>

        </form>
    </div>
</div>

@section Scripts {
    <script>
        let index = @Model.Count;

        function deleteRow(btn) {
            const row = btn.closest("tr");
            // Set IsDeleted flag to true and hide the row
            row.querySelector(".is-deleted-flag").value = "true";
            row.style.display = "none";
        }

        function addRequirement() {
            const tbody = document.getElementById("requirementsBody");

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <input type="hidden" name="requirements[${index}].Id" value="0" />
                    <input type="hidden" name="requirements[${index}].IsDeleted" value="false" class="is-deleted-flag" />
                    <input class="form-input"
                           name="requirements[${index}].Label"
                           placeholder="New field label" required />
                </td>

                <td>
                    <select name="requirements[${index}].FieldType" class="form-select">
                        <option value="text">text</option>
                        <option value="textarea">textarea</option>
                        <option value="date">date</option>
                        <option value="number">number</option>
                        <option value="email">email</option>
                        <option value="select">select</option>
                    </select>
                </td>

                <td class="text-center">
                    <input type="checkbox" name="requirements[${index}].IsRequired" value="true" />
                    <input type="hidden" name="requirements[${index}].IsRequired" value="false" />
                </td>

                <td>
                    <input class="form-input"
                           name="requirements[${index}].Options"
                           placeholder="Comma separated (for select)" />
                </td>

                <td class="text-center">
                    <button type="button"
                            class="btn-icon-danger"
                            onclick="deleteRow(this)">
                        🗑
                    </button>
                </td>
            `;

            tbody.appendChild(row);
            index++;
        }
    </script>
}