@model List<AdministrationPortal.Models.ViewModels.ServiceRequirementVM>

@{
    ViewData["Title"] = "Edit Service Requirements";
}

<div class="profile-container">
    <div class="profile-card highlight">

        <!-- HEADER -->
        <div class="page-header">
            <div>
                <h3>Edit Service Requirements</h3>
                <p class="text-muted">
                    Define what information residents must provide for this service
                </p>
            </div>
        </div>

        <form asp-action="SaveServiceRequirements" method="post">
            <input type="hidden" name="serviceId" value="@ViewBag.ServiceId" />

            <!-- REQUIREMENTS TABLE -->
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Field Label</th>
                        <th style="width:140px;">Type</th>
                        <th style="width:90px;">Required</th>
                        <th>Options</th>
                        <th style="width:70px;"></th>
                    </tr>
                </thead>

                <tbody id="requirementsBody">
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        <tr>
                            <td>
                                <input type="hidden" name="requirements[@i].Id" value="@Model[i].Id" />
                                <input type="hidden" name="requirements[@i].IsDeleted" value="false" />

                                <input class="form-input"
                                       name="requirements[@i].Label"
                                       value="@Model[i].Label"
                                       placeholder="e.g. Date of Birth" />
                            </td>

                            <td>
                                <select name="requirements[@i].FieldType" class="form-select">
                                    <option selected>@Model[i].FieldType</option>
                                    <option>text</option>
                                    <option>textarea</option>
                                    <option>date</option>
                                    <option>number</option>
                                    <option>email</option>
                                    <option>select</option>
                                </select>
                            </td>

                            <td class="text-center">
                                <input type="checkbox"
                                       name="requirements[@i].IsRequired"
                                       checked="@Model[i].IsRequired" />
                            </td>

                            <td>
                                <input class="form-input"
                                       name="requirements[@i].Options"
                                       value="@string.Join(",", Model[i].Options)"
                                       placeholder="Only for select fields" />
                            </td>

                            <td class="text-center">
                                <button type="button"
                                        class="btn-icon-danger"
                                        title="Delete field"
                                        onclick="deleteRow(this)">
                                    🗑
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- ADD REQUIREMENT -->
            <div class="center-actions">
                <button type="button"
                        class="btn-secondary btn-add"
                        onclick="addRequirement()">
                    ➕ Add Requirement
                </button>
            </div>

            <!-- ACTIONS -->
            <div class="profile-actions">
                <button type="submit" class="btn-primary">
                    Save Requirements
                </button>

                <a asp-action="BarangayServices" class="btn-secondary">
                    Cancel
                </a>
            </div>

        </form>
    </div>
</div>

@section Scripts {
    <script>
        let index = @Model.Count;

        function deleteRow(btn) {
            const row = btn.closest("tr");
            row.querySelector("input[name$='.IsDeleted']").value = "true";
            row.style.display = "none";
        }

        function addRequirement() {
            const tbody = document.getElementById("requirementsBody");

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <input type="hidden" name="requirements[${index}].Id" value="0" />
                    <input type="hidden" name="requirements[${index}].IsDeleted" value="false" />
                    <input class="form-input"
                           name="requirements[${index}].Label"
                           placeholder="New field label" />
                </td>

                <td>
                    <select name="requirements[${index}].FieldType" class="form-select">
                        <option>text</option>
                        <option>textarea</option>
                        <option>date</option>
                        <option>number</option>
                        <option>email</option>
                        <option>select</option>
                    </select>
                </td>

                <td class="text-center">
                    <input type="checkbox" name="requirements[${index}].IsRequired" />
                </td>

                <td>
                    <input class="form-input"
                           name="requirements[${index}].Options"
                           placeholder="Comma separated (for select)" />
                </td>

                <td class="text-center">
                    <button type="button"
                            class="btn-icon-danger"
                            onclick="deleteRow(this)">
                        🗑
                    </button>
                </td>
            `;

            tbody.appendChild(row);
            index++;
        }
    </script>
}
